```mermaid
flowchart TD
    A([старт]) --> B[задать threads blocks capacity]
    B --> C[выделить память gpu: stack top результаты]
    C --> D[запуск стека]
    D --> E[копировать данные gpu -> cpu]
    E --> F[посчитать push успешно]
    F --> G[проверить pop значения]
    G --> H{pop ошибка = 0}
    H -- нет --> Z[проверка: неуспешно]
    H -- да --> I[ожидалось top = push - pop]
    I --> J{top совпал}
    J -- нет --> Z
    J -- да --> K[проверка: успешно]
    K --> L([конец])

    subgraph STACK["GPU: стек"]
        S1[tid = global id] --> S2{tid = 0}
        S2 -- да --> S3[top = 0]
        S2 -- нет --> S4[пропустить]
        S3 --> S5[barrier]
        S4 --> S5

        S5 --> S6{tid четный}
        S6 -- да --> S7[push: pos = atomicAdd top]
        S7 --> S8{pos < capacity}
        S8 -- да --> S9[data pos = tid]
        S8 -- нет --> S10[откат top]

        S6 -- нет --> S11[pop: pos = atomicSub top - 1]
        S11 --> S12{pos >= 0}
        S12 -- да --> S13[v = data pos]
        S12 -- нет --> S14[откат top]
    end
