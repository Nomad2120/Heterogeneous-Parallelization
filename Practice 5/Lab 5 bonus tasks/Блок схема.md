```mermaid
flowchart TD
    A([старт]) --> B[задать threads blocks capacity]
    B --> C[выделить память gpu: buf head tail succ]
    C --> D[обнулить succ]
    D --> E[запуск q_enq + замер]
    E --> F[запуск q_deq + замер]
    F --> G[копировать succ на cpu]
    G --> H[запуск cpu очередь + замер]
    H --> I[запуск cpu стек + замер]
    I --> J[вывод результатов]
    J --> K[сравнение cpu и gpu]
    K --> L([конец])

    subgraph ENQ["CUDA ядро: q_enq (mpmc enqueue)"]
        E1[tid = global id] --> E2{tid = 0}
        E2 -- да --> E3[head = 0; tail = 0]
        E2 -- нет --> E4[пропустить]
        E3 --> E5[barrier]
        E4 --> E5

        E5 --> E6[ok_shared = 0]
        E6 --> E7[enqueue: pos = atomicAdd tail]
        E7 --> E8{pos < capacity}
        E8 -- да --> E9[data pos = tid]
        E9 --> E10[ok_shared++]
        E8 -- нет --> E11[откат tail]
        E10 --> E12{threadIdx = 0}
        E11 --> E12
        E12 -- да --> E13[atomicAdd succ_global, ok_shared]
    end

    subgraph DEQ["CUDA ядро: q_deq (mpmc dequeue)"]
        D1[tid = global id] --> D2[ok_shared = 0]
        D2 --> D3[dequeue: pos = atomicAdd head]
        D3 --> D4[прочитать tail_now]
        D4 --> D5{pos < tail_now}
        D5 -- да --> D6[v = data pos]
        D6 --> D7[ok_shared++]
        D5 -- нет --> D8[откат head]
        D7 --> D9{threadIdx = 0}
        D8 --> D9
        D9 -- да --> D10[atomicAdd succ_global, ok_shared]
    end
